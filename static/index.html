<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tor Exit Node</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    main {
      max-width: 600px;
      width: 100%;
    }
    a {
      color: #7e57c2;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .logo {
      display: block;
      margin: 0 auto 1rem;
      width: 80px;
      height: 80px;
    }
    .hero {
      margin-bottom: 1.25rem;
    }
    .hero-nickname {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      font-size: 1.5rem;
      font-weight: 600;
      color: #fff;
    }
    .hero-subtitle {
      font-size: 0.875rem;
      color: #555;
      margin-top: 0.25rem;
    }
    .hero-subtitle span {
      color: #7e57c2;
    }
    .indicator {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .indicator.online {
      background: #4caf50;
      box-shadow: 0 0 6px #4caf50;
      animation: pulse 2s ease-in-out infinite;
    }
    .indicator.offline {
      background: #f44336;
      box-shadow: 0 0 6px #f44336;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .fingerprint {
      font-family: "SF Mono", "Menlo", "Consolas", monospace;
      font-size: 0.8125rem;
      color: #666;
      margin-top: 0.75rem;
      word-break: break-all;
    }
    .fingerprint-label {
      color: #444;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.75rem;
      margin-right: 0.375rem;
    }
    @media (max-width: 480px) {
      .fingerprint-label {
        display: block;
        margin-bottom: 0.125rem;
      }
    }
    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat {
      background: #181818;
      border-radius: 8px;
      padding: 1rem;
    }
    .stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #666;
      margin-bottom: 0.25rem;
    }
    .stat-value {
      font-size: 1.125rem;
      font-weight: 600;
      color: #fff;
    }
    .flags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.375rem;
      margin-top: 0.25rem;
    }
    .flag {
      font-size: 0.75rem;
      font-weight: 500;
      background: #222;
      color: #a0a0a0;
      padding: 0.125rem 0.5rem;
      border-radius: 4px;
    }
    .stat-wide {
      grid-column: 1 / -1;
    }
    .chart {
      width: 100%;
      height: 80px;
      margin-top: 0.5rem;
    }
    .chart-legend {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: #666;
    }
    .chart-legend-item {
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }
    .chart-legend-color {
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }
    .chart-legend-color.read { background: rgba(126, 87, 194, 0.8); }
    .chart-legend-color.write { background: rgba(126, 87, 194, 0.4); }
    @media (max-width: 480px) {
      .stat-label { font-size: 0.625rem; }
    }
    .hidden { display: none; }
    .separator {
      border: none;
      border-top: 1px solid #222;
      margin: 1.5rem 0;
    }
    .notice {
      font-size: 0.8125rem;
      color: #555;
      line-height: 1.7;
    }
    .notice p {
      margin-bottom: 0.75rem;
    }
    .notice p:last-child {
      margin-bottom: 0;
    }
  </style>
</head>
<body>
  <main>
    <div id="relay-info" class="hidden">
      <div class="hero">
        <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <circle cx="50" cy="50" r="48" fill="none" stroke="#7e57c2" stroke-width="1.5" opacity="0.15"/>
          <circle cx="50" cy="50" r="36" fill="none" stroke="#7e57c2" stroke-width="1.5" opacity="0.25"/>
          <circle cx="50" cy="50" r="24" fill="none" stroke="#7e57c2" stroke-width="1.5" opacity="0.4"/>
          <circle cx="50" cy="50" r="12" fill="none" stroke="#7e57c2" stroke-width="1.5" opacity="0.6"/>
          <circle cx="50" cy="50" r="3" fill="#7e57c2" opacity="0.8"/>
        </svg>
        <div class="hero-nickname">
          <span class="indicator" id="status-indicator"></span>
          <span id="nickname"></span>
        </div>
        <div class="fingerprint"><span class="fingerprint-label">Fingerprint</span> <span id="fingerprint"></span></div>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="stat-label">Relay Type</div>
          <div class="stat-value">Exit</div>
        </div>
        <div class="stat">
          <div class="stat-label">Online For</div>
          <div class="stat-value" id="online-since"></div>
        </div>
        <div class="stat">
          <div class="stat-label">Total Transferred</div>
          <div class="stat-value" id="total-bandwidth"></div>
        </div>
        <div class="stat">
          <div class="stat-label">Tor Version</div>
          <div class="stat-value" id="version"></div>
        </div>
        <div class="stat stat-wide">
          <div class="stat-label">Flags</div>
          <div class="flags" id="flags"></div>
        </div>
        <div class="stat stat-wide">
          <div class="stat-label">Daily Traffic (6 months)</div>
          <canvas class="chart" id="chart"></canvas>
          <div class="chart-legend">
            <span class="chart-legend-item"><span class="chart-legend-color read"></span>Read</span>
            <span class="chart-legend-item"><span class="chart-legend-color write"></span>Write</span>
          </div>
        </div>
      </div>
    </div>

    <hr class="separator">

    <div class="notice">
      <p>
        If you're investigating abuse from this IP address, please note that this
        server is a <a href="https://www.torproject.org/">Tor</a> exit relay. It
        forwards traffic on behalf of anonymous Tor users &mdash; the operator of
        this server has no control over, knowledge of, or logs of the traffic
        passing through it. Blocking this IP will not stop the abuser, as their
        traffic will simply exit through a different relay.
      </p>
      <p>
        <a href="https://community.torproject.org/relay/community-resources/tor-abuse-templates/">Abuse response templates</a>
        &middot;
        <a href="https://community.torproject.org/relay/community-resources/eff-tor-legal-faq/">EFF legal FAQ</a>
        &middot;
        <a href="https://www.torproject.org/about/overview">What is Tor?</a>
      </p>
    </div>
  </main>

  <script>
    const FINGERPRINT = 'DE529B21A8A67AB8CA40329044FB4708D39E437C';
    const API = 'https://onionoo.torproject.org';

    function formatBytes(bytes) {
      const units = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
      let i = 0;
      while (bytes >= 1024 && i < units.length - 1) { bytes /= 1024; i++; }
      return bytes.toFixed(i > 0 ? 1 : 0) + ' ' + units[i];
    }

    function formatDuration(dateStr) {
      if (!dateStr) return 'Unknown';
      const start = new Date(dateStr.replace(' ', 'T') + 'Z');
      if (isNaN(start)) return 'Unknown';
      const now = new Date();
      let years = now.getUTCFullYear() - start.getUTCFullYear();
      let months = now.getUTCMonth() - start.getUTCMonth();
      let days = now.getUTCDate() - start.getUTCDate();
      if (days < 0) {
        months--;
        const prev = new Date(now.getUTCFullYear(), now.getUTCMonth(), 0);
        days += prev.getDate();
      }
      if (months < 0) {
        years--;
        months += 12;
      }
      const parts = [];
      if (years > 0) parts.push(years + (years === 1 ? ' year' : ' years'));
      if (months > 0) parts.push(months + (months === 1 ? ' month' : ' months'));
      if (years === 0 && months === 0) parts.push(days + (days === 1 ? ' day' : ' days'));
      return parts.join(' ') || '0 days';
    }

    function drawChart(canvas, writeHistory, readHistory) {
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);

      const w = rect.width;
      const h = rect.height;

      const wFactor = Number(writeHistory.factor);
      const rFactor = Number(readHistory.factor);
      const interval = Number(writeHistory.interval);
      const writeVals = (writeHistory.values || []).map(v => v === null ? 0 : v * wFactor * interval);
      const readVals = (readHistory.values || []).map(v => v === null ? 0 : v * rFactor * interval);
      const max = Math.max(...writeVals, ...readVals, 1);

      const label = formatBytes(max);
      ctx.font = '11px -apple-system, BlinkMacSystemFont, sans-serif';
      const labelW = ctx.measureText(label).width + 12;
      const chartW = w - labelW;
      const count = writeVals.length;
      const barW = chartW / count;

      ctx.fillStyle = '#444';
      ctx.textAlign = 'right';
      ctx.textBaseline = 'top';
      ctx.fillText(label, labelW - 6, 0);
      ctx.textBaseline = 'bottom';
      ctx.fillText('0 GB', labelW - 6, h);

      function drawBars(vals, color) {
        ctx.fillStyle = color;
        for (let i = 0; i < vals.length; i++) {
          const barH = (vals[i] / max) * h;
          ctx.fillRect(labelW + i * barW, h - barH, barW - 1, barH);
        }
      }

      drawBars(writeVals, 'rgba(126, 87, 194, 0.4)');
      drawBars(readVals, 'rgba(126, 87, 194, 0.8)');
    }

    async function load() {
      try {
        const [details, bw] = await Promise.all([
          fetch(`${API}/details?lookup=${FINGERPRINT}`).then(r => r.json()),
          fetch(`${API}/bandwidth?lookup=${FINGERPRINT}`).then(r => r.json()),
        ]);

        const relay = details.relays[0];
        if (!relay) return;

        const indicator = document.getElementById('status-indicator');
        indicator.classList.add(relay.running ? 'online' : 'offline');

        document.getElementById('nickname').textContent = relay.nickname;
        document.getElementById('fingerprint').textContent = relay.fingerprint;
        document.getElementById('online-since').textContent = formatDuration(relay.first_seen);
        document.getElementById('version').textContent = relay.version;

        const flagsEl = document.getElementById('flags');
        relay.flags.forEach(f => {
          const el = document.createElement('span');
          el.className = 'flag';
          el.textContent = f;
          flagsEl.appendChild(el);
        });

        const bwRelay = bw.relays[0];
        if (bwRelay) {
          let totalBytes = 0;
          const periods = ['5_years', '1_year', '6_months', '1_month'];
          const usedPeriod = periods.find(p => bwRelay.write_history[p]);
          if (usedPeriod) {
            const wh = bwRelay.write_history[usedPeriod];
            const rh = bwRelay.read_history[usedPeriod];
            const interval = wh.interval;
            wh.values.forEach(v => { totalBytes += (v || 0) * wh.factor * interval; });
            rh.values.forEach(v => { totalBytes += (v || 0) * rh.factor * interval; });
          }
          document.getElementById('total-bandwidth').textContent = formatBytes(totalBytes);
        }

        document.getElementById('relay-info').classList.remove('hidden');

        if (bwRelay) {
          const chartPeriod = ['5_years', '1_year', '6_months', '1_month'].find(p => bwRelay.write_history[p]);
          if (chartPeriod) {
            drawChart(
              document.getElementById('chart'),
              bwRelay.write_history[chartPeriod],
              bwRelay.read_history[chartPeriod],
            );
          }
        }
      } catch (e) {
        // Stats unavailable, page still works as a static notice
      }
    }

    load();
  </script>
</body>
</html>
